# Bradax Broker - Hub Corporativo LangChain

> **Broker empresarial para SDK LangChain com autentica√ß√£o por projeto, guardrails autom√°ticos e telemetria integrada.**

## üèóÔ∏è Vis√£o Geral Arquitetural

O Bradax Broker √© um proxy corporativo que centraliza o acesso a modelos LLM atrav√©s de interface LangChain, aplicando pol√≠ticas de governan√ßa, autentica√ß√£o baseada em projetos e coleta de telemetria em tempo real.

```mermaid
graph TB
    SDK[Bradax SDK - Interface LangChain] -->|invoke/ainvoke| AUTH[Autentica√ß√£o]
    AUTH --> GUARD[Guardrails]
    GUARD --> LLM[Servi√ßo LLM]
    LLM --> PROVIDER[Provider LangChain]
    PROVIDER --> OPENAI[OpenAI API]
    
    AUTH --> TELEM[Telemetria]
    GUARD --> TELEM
    LLM --> TELEM
    TELEM --> STORAGE[Storage JSON]
    
    subgraph "Middleware Stack"
        SECURITY[Security]
        CORS[CORS]
        LOGGING[Logging]
        RATE[Rate Limiting]
    end
```

## üéØ Casos de Uso Corporativos

### 1. Interface LangChain Padronizada
```python
# SDK LangChain-compat√≠vel se autentica com broker
config = BradaxSDKConfig.for_development(
    broker_url="http://localhost:8000",
    project_id="acme-ai-assistant"
)
client = BradaxClient(config)

# Interface LangChain padr√£o
response = client.invoke("Analise este documento corporativo...")
print(response["content"])
```

### 2. Guardrails Autom√°ticos por Projeto
```python
# Pol√≠tica aplicada automaticamente por projeto
{
    "content_filters": ["pii", "confidential"],
    "max_tokens": 2000,
    "allowed_domains": ["empresa.com"],
    "compliance": "LGPD"
}
```

### 3. Telemetria e Auditoria
```python
# Coleta autom√°tica de m√©tricas
{
    "request_id": "req_789xyz",
    "project": "acme_ai_assistant", 
    "model": "gpt-4o-mini",
    "tokens_used": 1250,
    "cost": 0.15,
    "timestamp": "2025-07-29T01:15:30Z",
    "user_department": "marketing"
}
```

## ‚öôÔ∏è Configura√ß√£o de Environment

### Vari√°veis Obrigat√≥rias

```bash
# JWT Secret (OBRIGAT√ìRIO para seguran√ßa)
export BRADAX_JWT_SECRET="$(openssl rand -base64 32)"

# OpenAI API Key (OBRIGAT√ìRIO para LLM)
export OPENAI_API_KEY="sk-your-openai-key-here"
```

### Vari√°veis Opcionais

```bash
# Environment  
export BRADAX_ENV="production"  # development|testing|staging|production

# JWT Configuration
export BRADAX_JWT_EXPIRE_MINUTES="15"  # Token expiration (default: 15min)

# Rate Limiting
export BRADAX_RATE_LIMIT_RPM="60"      # Requests per minute (default: 60)
export BRADAX_RATE_LIMIT_RPH="1000"    # Requests per hour (default: 1000)
export BRADAX_MAX_CONCURRENT="10"      # Max concurrent requests (default: 10)

# Network Timeouts
export BRADAX_HUB_LLM_TIMEOUT="180"    # LLM timeout in seconds (default: 180)
```

### Setup R√°pido para Desenvolvimento

```bash
# Gerar JWT secret seguro
export BRADAX_JWT_SECRET="$(openssl rand -base64 32)"

# Configurar OpenAI  
export OPENAI_API_KEY="sk-your-key-here"

# Executar broker
cd bradax-broker
python -m uvicorn broker.main:app --reload --port 8080
```

### Setup para Produ√ß√£o

```bash
# JWT secret gerado com alta entropia
export BRADAX_JWT_SECRET="$(openssl rand -base64 48)"

# Environment de produ√ß√£o
export BRADAX_ENV="production"

# Rate limiting mais restritivo
export BRADAX_RATE_LIMIT_RPM="30"
export BRADAX_MAX_CONCURRENT="5"

# Executar com bind espec√≠fico
python -m uvicorn broker.main:app --host 0.0.0.0 --port 8080
```

## üõ†Ô∏è Endpoints Principais

### Autentica√ß√£o e Projetos
```http
POST /api/v1/auth/validate
Authorization: Bearer proj_token_here
```

### Opera√ß√µes LLM
```http
# Execu√ß√£o de modelo - Formato LangChain (padr√£o)
POST /api/v1/llm/invoke
{
    "operation": "chat",
    "model": "gpt-4o-mini", 
    "payload": {
        "messages": [
            {"role": "user", "content": "Sua pergunta aqui"}
        ],
        "max_tokens": 1000,
        "temperature": 0.7
    },
    "project_id": "acme_ai_assistant"
}

# Tamb√©m suporta formato legado (compatibilidade)
POST /api/v1/llm/invoke
{
    "operation": "chat",
    "model": "gpt-4o-mini", 
    "payload": {
        "prompt": "Sua pergunta aqui",
        "max_tokens": 1000
    },
    "project_id": "acme_ai_assistant"
}

# Listar modelos dispon√≠veis
GET /api/v1/llm/models?project_id=acme_ai_assistant
```

### Sistema e Telemetria
```http
# Status do sistema
GET /api/v1/system/health

# M√©tricas do projeto
GET /api/v1/system/metrics?project_id=acme_ai_assistant

# Telemetria em tempo real
GET /api/v1/system/telemetry?period=1d
```

### Gerenciamento de Projetos
```http
# Informa√ß√µes do projeto
GET /api/v1/management/projects/{project_id}

# Configurar guardrails
PUT /api/v1/management/projects/{project_id}/guardrails
{
    "content_filters": ["pii"],
    "max_daily_tokens": 50000,
    "allowed_models": ["gpt-4o-mini", "gpt-3.5-turbo"]
}
```

## üîê Seguran√ßa e Autentica√ß√£o

### Modelo de Autentica√ß√£o
- **Por Projeto:** Cada projeto corporativo tem token √∫nico
- **Valida√ß√£o Cont√≠nua:** Tokens validados a cada requisi√ß√£o
- **Escopo Limitado:** Projetos s√≥ acessam seus recursos autorizados

### Headers Obrigat√≥rios
```http
Authorization: Bearer proj_acme_2025_ai_assistant_001
Content-Type: application/json
X-Project-Token: proj_acme_2025_ai_assistant_001
```

### Middleware de Seguran√ßa
1. **SecurityMiddleware:** Headers de seguran√ßa, rate limiting
2. **AuthenticationMiddleware:** Valida√ß√£o de tokens
3. **LoggingMiddleware:** Auditoria completa de requisi√ß√µes
4. **CORSMiddleware:** Controle de origens permitidas

## üìä Sistema de Telemetria

### Coleta Autom√°tica
- **Requisi√ß√µes:** Todas as chamadas s√£o registradas
- **Performance:** Lat√™ncia, throughput, errors
- **Custos:** Tokens consumidos por projeto/modelo
- **Compliance:** Logs para auditoria corporativa

### M√©tricas Dispon√≠veis
```json
{
    "project_metrics": {
        "total_requests": 15420,
        "total_tokens": 2500000,
        "total_cost": 375.50,
        "avg_latency_ms": 850,
        "error_rate": 0.02
    },
    "model_usage": {
        "gpt-4o-mini": {
            "requests": 12000,
            "tokens": 1800000,
            "cost": 270.00
        },
        "gpt-3.5-turbo": {
            "requests": 3420,
            "tokens": 700000,
            "cost": 105.50
        }
    }
}
```

## üõ°Ô∏è Sistema de Guardrails

### Guardrails Autom√°ticos
- **Valida√ß√£o de Conte√∫do:** Filtros de PII, conte√∫do impr√≥prio
- **Limites de Uso:** Tokens por per√≠odo, requisi√ß√µes por minuto
- **Compliance:** LGPD, GDPR, pol√≠ticas corporativas
- **Modelo Apropriado:** Valida√ß√£o de modelo vs projeto

### Configura√ß√£o por Projeto
```json
{
    "guardrails": {
        "content_policy": {
            "filter_pii": true,
            "filter_confidential": true,
            "max_content_length": 10000
        },
        "usage_limits": {
            "max_tokens_per_day": 100000,
            "max_requests_per_minute": 50,
            "max_cost_per_month": 1000.00
        },
        "compliance": {
            "data_residency": "BR",
            "audit_level": "full",
            "retention_days": 90
        }
    }
}
```

## üîß Integra√ß√£o com LangChain

### Providers Suportados
- **OpenAI:** GPT-4o, GPT-4o-mini, GPT-3.5-turbo
- **Anthropic:** Claude (futuro)
- **Google:** Gemini (futuro)

### Configura√ß√£o de Modelos
```python
# Configura√ß√£o no projeto
{
    "allowed_models": [
        {
            "model_id": "gpt-4o-mini",
            "max_tokens": 4096,
            "cost_per_token": 0.00015,
            "enabled": true
        }
    ]
}
```

## üìà Monitoramento e Observabilidade

### Health Checks
```http
GET /health
{
    "status": "healthy",
    "timestamp": "2025-07-29T01:15:30Z",
    "services": {
        "llm_service": "up",
        "storage": "up", 
        "auth": "up"
    }
}
```

### Logs Estruturados
```json
{
    "timestamp": "2025-07-29T01:15:30Z",
    "level": "INFO",
    "service": "llm_controller",
    "request_id": "req_789xyz",
    "project_id": "acme_ai_assistant",
    "action": "llm_invoke",
    "model": "gpt-4o-mini",
    "tokens": 1250,
    "latency_ms": 850,
    "status": "success"
}
```

## üöÄ Integra√ß√£o SDK-Broker

### 1. Configura√ß√£o e Uso B√°sico
```python
from bradax import BradaxClient
from bradax.config import BradaxSDKConfig

# Configura√ß√£o para o broker
config = BradaxSDKConfig.for_integration_tests(
    broker_url="https://llm.empresa.com",
    project_id="acme_ai_assistant",
    api_key="your_api_key"
)

client = BradaxClient(config)

# Uso LangChain-compatible
response = client.invoke("Analise este documento...")
print(response["content"])
```

### 2. Processamento com Mensagens Estruturadas  
```python
# Formato LangChain com roles
messages = [
    {"role": "system", "content": "Voc√™ √© um assistente especializado"},
    {"role": "user", "content": "Resuma este relat√≥rio"}
]

response = client.invoke(messages, config={"model": "gpt-4o"})
```

### 3. Processamento Ass√≠ncrono
```python
# Uso ass√≠ncrono para opera√ß√µes longas
async def process_document(text):
    response = await client.ainvoke(
        f"Analise este documento: {text}",
        config={"temperature": 0.1}
    )
    return response["content"]
```
    print(chunk, end="")
```

### 3. Fun√ß√£o Calling
```python
# Execu√ß√£o de fun√ß√µes
response = client.run_llm(
    prompt="Qual a previs√£o do tempo em S√£o Paulo?",
    model="gpt-4o",
    functions=[{
        "name": "get_weather",
        "description": "Obter previs√£o do tempo",
        "parameters": {"city": "string"}
    }]
)
```

## üîÑ Arquitetura de Dados

### Fluxo de Dados
```
Cliente ‚Üí Auth ‚Üí Guardrails ‚Üí LLM ‚Üí Provider ‚Üí Response
    ‚Üì        ‚Üì         ‚Üì        ‚Üì
  Telemetria ‚Üê Storage ‚Üê Logs ‚Üê Metrics
```

### Persist√™ncia
- **Projetos:** `data/projects.json`
- **Guardrails:** `data/guardrails.json` 
- **Telemetria:** `data/telemetry.json`
- **Sistema:** `data/system_info.json`

## üè¢ Governan√ßa Corporativa

### Pol√≠ticas Implementadas
- **Autentica√ß√£o Obrigat√≥ria:** Nenhuma requisi√ß√£o sem token
- **Auditoria Completa:** Logs de todas as opera√ß√µes
- **Controle de Custos:** Limites por projeto e per√≠odo
- **Compliance Autom√°tico:** Filtros e valida√ß√µes obrigat√≥rias

### Relat√≥rios Executivos
- **Dashboard de Uso:** M√©tricas por departamento
- **An√°lise de Custos:** ROI por projeto
- **Compliance Reports:** Auditoria para certifica√ß√µes
- **Performance Analytics:** Otimiza√ß√£o de uso

---

> **üí° Nota:** Este broker foi projetado para ambientes corporativos que exigem controle total sobre o uso de LLM, com foco em seguran√ßa, auditoria e governan√ßa.
